<!DOCTYPE html>
<html lang="en">
<head>
	<title>Smoke</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" rel="stylesheet" href="../examples/main.css">
</head>
<body>


<script type="module">

	import * as THREE from '../build/three.module.js';
	import {EffectComposer} from '../examples/jsm/postprocessing/EffectComposer.js';
	import {RenderPass} from '../examples/jsm/postprocessing/RenderPass.js';
	import {ShaderPass} from '../examples/jsm/postprocessing/ShaderPass.js';
	import {OutlinePass} from '../examples/jsm/postprocessing/OutlinePass.js';
	import {FXAAShader} from '../examples/jsm/shaders/FXAAShader.js';


	let camera, cameraTarget, scene, renderer, geometry, material, mesh;
	let composer, effectFXAA, outlinePass;

	let cubeSineDriver, textTexture, textMaterial, text, light, smokeTexture, smokeMaterial, smokeGeo, smokeParticles,
			textGeo, p, clock, delta;

	let mainColor = '#ff9304';
    let secondaryColor = '#00ffff';

	init();
	animate();

	function addEnvironmentCube() {
		geometry = new THREE.CubeGeometry(200, 200, 200);
		material = new THREE.MeshLambertMaterial({color: '#aa6666', wireframe: false});
		mesh = new THREE.Mesh(geometry, material);
		cubeSineDriver = 0;
	}

	function addLetters() {
		let loader = new THREE.FontLoader();
		loader.load( '../examples/fonts/helvetiker_regular.typeface.json', function ( font ) {
			let xMid;

			textMaterial = new THREE.MeshStandardMaterial( {
				color: mainColor,
				transparent: true,
				opacity: .8,
				side: THREE.DoubleSide,
				metalness: .5,
				roughness: .5
			} );

			let message = "Schlage\nEncode";
			let shapes = font.generateShapes( message, 30 );
			let geometry = new THREE.ShapeBufferGeometry( shapes );
			geometry.computeBoundingBox();
			xMid = - 0.5 * ( geometry.boundingBox.max.x - geometry.boundingBox.min.x );
			geometry.translate( xMid, 0, 0 );
			text = new THREE.Mesh( geometry, textMaterial );
			text.position.z = 800;
			scene.add( text );
			outlinePass.selectedObjects = [text];

		} );
	}

	function addLettersWithPicture() {
		textGeo = new THREE.PlaneGeometry(300, 300);
		textTexture = THREE.ImageUtils.loadTexture('../sandbox/textures/smokeText.png');
		textMaterial = new THREE.MeshLambertMaterial({
			color: mainColor,
			opacity: 1,
			map: textTexture,
			transparent: true,
			blending: THREE.AdditiveBlending
		});
		text = new THREE.Mesh(textGeo, textMaterial);
		text.position.z = 800;
		scene.add(text);

	}

	function addLight() {
		light = new THREE.DirectionalLight(0xffffff, 0.5);
		light.position.set(-1, 0, 1);
		scene.add(light);
	}

	function addSmoke() {
		smokeTexture = THREE.ImageUtils.loadTexture('../sandbox/textures/Smoke-Element.png');
		smokeMaterial = new THREE.MeshLambertMaterial({color: mainColor, map: smokeTexture, transparent: true});
		smokeGeo = new THREE.PlaneGeometry(300, 300);
		smokeParticles = [];

		for (p = 0; p < 150; p++) {
			let particle = new THREE.Mesh(smokeGeo, smokeMaterial);
			particle.position.set(Math.random() * 500 - 250, Math.random() * 500 - 250, Math.random() * 1000 - 100);
			particle.rotation.z = Math.random() * 360;
			scene.add(particle);
			smokeParticles.push(particle);
		}
	}

	function initPostProcessing() {

		composer = new EffectComposer(renderer);
		let renderPass = new RenderPass(scene, camera);
		composer.addPass(renderPass);

		outlinePass = new OutlinePass(new THREE.Vector2(window.innerWidth, window.innerHeight), scene, camera);
		composer.addPass(outlinePass);
		effectFXAA = new ShaderPass(FXAAShader);
		effectFXAA.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);
		composer.addPass(effectFXAA);
/*		outlinePass.edgeGlow = 0;
		outlinePass.edgeStrength = 3.0;
		outlinePass.edgeThickness = 3.2;*/
		outlinePass.visibleEdgeColor = new THREE.Color( mainColor );

	}


	function init() {

		clock = new THREE.Clock();

		renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);

		scene = new THREE.Scene();

		camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
		camera.position.z = 1000;
		scene.add(camera);
		initPostProcessing();

		addEnvironmentCube();
		//addLettersWithPicture();
		addLetters();
		addLight();
		addSmoke();

		document.body.appendChild(renderer.domElement);

		window.addEventListener('resize', onWindowResize, false);
	}


	function onWindowResize() {

		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();

		renderer.setSize(window.innerWidth, window.innerHeight);

	}

	function animate() {

		delta = clock.getDelta();
		requestAnimationFrame(animate);
		evolveSmoke();
		render();
		composer.render();

	}

	function evolveSmoke() {
		var sp = smokeParticles.length;
		while (sp--) {
			smokeParticles[sp].rotation.z += (delta * 0.2);
		}
	}

	function render() {
		mesh.rotation.x += 0.005;
		mesh.rotation.y += 0.01;
		cubeSineDriver += .01;
		mesh.position.z = 100 + (Math.sin(cubeSineDriver) * 500);
		renderer.render(scene, camera);

	}

</script>
</body>
</html>
